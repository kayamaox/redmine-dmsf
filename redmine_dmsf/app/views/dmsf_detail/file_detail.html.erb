<% html_title(l(:dmsf)) %>

<div class="contextual">
</div>

<% path = @file.folder.nil? ? [] : @file.folder.dmsf_path %>
<h2>
<%= render(:partial => "/dmsf/path", :locals => {:path => path}) %>
/ 
<%= h(@file.last_revision.title) %> <div style="float: right"><%= h(@file.name) %></div>
<% if @file.notification %>
	<%= image_tag("notify.png", :plugin => "redmine_dmsf",
		:title => l(:title_notifications_active)) %>
<% end %>
</h2>

<% if User.current.allowed_to?(:file_manipulation, @file.project) %>
	<%= render(:partial => 'file_new_revision') %>
<% end %>

<h3><%= l(:heading_revisions) %></h3>
<% @file.revisions.each do |revision| %>
<div class="box dmsf_detail">
	<div style="float:right">
		<%=  link_to(l(:title_download),
          {:controller=>"dmsf", :action => "download_revision", :id => @project, :revision_id => revision}) %>
		<% if User.current.allowed_to?(:file_approval, @project) %>
			| <%=  link_to(l(:title_delete),
	          {:action => "delete_revision", :id => @project, :revision_id => revision},
			  :class => "delete-link", :title => l(:title_delete_revision)) %>
		<% end %>
	</div>
		<p class="no-ident">
			<%= label_tag("", (revision.source_revision.nil? ? l(:label_created) : l(:label_changed))  + ":") %>
			<%= l(:info_changed_by_user, :changed => revision.updated_at.strftime("%Y-%m-%d %H:%M:%S"), :user => h(revision.user)) %>
		</p>
		<div class="clear">
			<div class="splitcontentleft">
				<p>
					<%= label_tag("", l(:label_title) + ":") %>
					<%= h(revision.title) %>
				</p>
			</div>
			<div class="splitcontentright">
				<p>
					<%= label_tag("", l(:label_filename) + ":") %>
					<%= h(revision.name) %>
				</p>
			</div>
		</div>
		<p class="no-ident">
			<%= label_tag("", l(:label_description) + ":") %>
		</p>
		<div class="wiki clear" style="margin-left: 110px">
			<%= textilizable(revision.description) %>
		</div>
		
		<div class="splitcontentleft">
			<p>
				<%= label_tag("", l(:label_version) + ":") %>
				<%= revision.major_version %>.<%= revision.minor_version %>
			</p>
			<p>
				<%= label_tag("", l(:label_workflow) + ":") %>
				<%= case revision.workflow
						when 1 then l(:option_workflow_waiting_for_approval)
						when 2 then l(:option_workflow_approved)
						else l(:option_workflow_none) 
					end %>
			</p>
		</div>
		<div class="splitcontentright clear">
			<p>
				<%= label_tag("", l(:label_mime) + ":") %>
				<%= h(revision.mime_type) %>&nbsp;
			</p>
			<p>
				<%= label_tag("", l(:label_size) + ":") %>
				<%= number_to_human_size(revision.size) %>
			</p>
		</div>
		<br style="clear: both"/>
		<p class="no-ident clear">
			<%= label_tag("", l(:label_comment) + ":") %>
			<%= h(revision.comment) %>
		</p>
</div>
<% end %>

<% content_for :header_tags do %>
	<%= stylesheet_link_tag "dmsf", :plugin => "redmine_dmsf" %>
	<%= javascript_include_tag "https://ajax.googleapis.com/ajax/libs/jquery/1.6.0/jquery.min.js" %>
	<script type="text/javascript">
		jQuery.noConflict();
		
		jQuery(document).ready(function() {
			jQuery("a.delete-link").click(function(event) {
				if(!window.confirm("<%= l(:question_do_you_really_want_to_delete_this_revision) %>")) event.preventDefault();
			})
			
			jQuery("#fileFileUpload").change(function() {
				if(jQuery("input[name=\"file[version]\"]:checked").val() == "same") {
					jQuery("#fileMinorVersionRadio").prop("checked", true); 
				}
				jQuery("#fileSameVersionRadio").prop("disabled", true); 
			});
			
			jQuery("#newRevisionFormContentToggle").toggle(function() {
				jQuery("#newRevisionFormContentToggle").text("[-]");
				jQuery("#newRevisionFormContent").show();
			}, function() {
				jQuery("#newRevisionFormContentToggle").text("[+]");
				jQuery("#newRevisionFormContent").hide();
			});
			jQuery("#newRevisionFormContentToggle").text("[+]");
			jQuery("#newRevisionFormContent").hide();
		});
	</script>
<% end %>